
==============
アクション定義
==============

| Exastro OASE から、Exastro IT Automation やメールサーバと連携するために、ディシジョンテーブルファイルの :menuselection:`アクションパラメータ情報` に適切なパラメータを記載する必要があります。
| 本項では、連携可能なアプリケーションとそのパラメータ情報の記載方法について説明します。


Exastro IT Automation 連携
==========================

| Exastro IT Automation (ITA) と連携する際に利用するアクションパラメータについて記載します。
| ITA と連携する場合、作業対象のホストや投入するパラメータを ITA と OASE のどちらで管理するかによってアクションパラメータの記載方法が変わってきます。

ITAアクションパラメータ
-----------------------

+----------------+-------------------------+-----------------------------------------------------------------------------------------------+---------------------------------------+
| パラメータ分類 | パラメータ変数          | パラメータ値                                                                                  | 入力例                                |
+================+=========================+===============================================================================================+=======================================+
| ドライバ名     | ITA_NAME                | ITAドライバ名。                                                                               | ITA_NAME=exastro-ita01                |
+                +                         +                                                                                               +                                       +
|                |                         | 必須項目です。                                                                                |                                       |
+----------------+-------------------------+-----------------------------------------------------------------------------------------------+---------------------------------------+
| ジョブフロー   | CONDUCTOR_CLASS_ID      | 実行するConductorクラスID。                                                                   | CONDUCTOR_CLASS_ID=2                  |
+                +                         +                                                                                               +                                       +
|                |                         | ConductorクラスIDはConductorクラス一覧で確認できます。                                        |                                       |
+                +                         +                                                                                               +                                       +
|                |                         | SYMPHONY_CLASS_IDのどちらか一つのみを選択する必要があります。                                 |                                       |
+                +-------------------------+-----------------------------------------------------------------------------------------------+---------------------------------------+
|                | SYMPHONY_CLASS_ID       | 実行するSymphonyクラスID。                                                                    | SYMPHONY_CLASS_ID=3                   |
+                +                         +                                                                                               +                                       +
|                |                         | SymphonyクラスIDはSymphonyクラス一覧で確認できます。                                          |                                       |
+                +                         +                                                                                               +                                       +
|                |                         | CONDUCTOR_CLASS_IDのどちらか一つのみを選択する必要があります。                                |                                       |
+----------------+-------------------------+-----------------------------------------------------------------------------------------------+---------------------------------------+
| オペレーション | OPERATION_ID            | 作業を実行する際に利用するオペレーションID。                                                  | OPERATION_ID=4                        |
+                +                         +                                                                                               +                                       +
|                |                         | OPERATION_ID を利用する場合、作業対象やメニュー連携はできません。                             |                                       |
+----------------+-------------------------+-----------------------------------------------------------------------------------------------+---------------------------------------+
| 投入パラメータ | MENU_ID                 | ITA のメニューIDを指定。                                                                      | MENU_ID=1                             |
+                +                         +                                                                                               +                                       +
|                |                         | 連携可能なメニューはホストグループ利用が有効になっているメニューに限られます。                | MENU_ID=1:2                           |
+                +                         +                                                                                               +                                       +
|                |                         | <メニューID>:<メニューID>:...                                                                 |                                       |
+                +                         +                                                                                               +                                       +
|                |                         | CONVERT_FLGの指定が必要です。                                                                 |                                       |
+                +-------------------------+-----------------------------------------------------------------------------------------------+---------------------------------------+
|                | CONVERT_FLG             | 作業対象のホストをメッセージから利用するためのフラグです。                                    | CONVERT_FLG=TRUE                      |
+                +                         +                                                                                               +                                       +
|                |                         | MEMU_IDの利用時に指定が必要です。                                                             | CONVERT_FLG=FALSE                     |
+                +                         +                                                                                               +                                       +
|                |                         | :kbd:`TRUE` : 取得したメッセージを作業対象ホスト名として利用します。                          |                                       |
+                +                         +                                                                                               +                                       +
|                |                         | :kbd:`FALSE` : 取得したメッセージの一部を抽出した文字列を作業対象ホスト名として利用します。   |                                       |
+----------------+-------------------------+-----------------------------------------------------------------------------------------------+---------------------------------------+
| 作業対象       | SERVER_LIST             | ITA の機器一覧に登録されている作業対象ホスト。                                                | SERVER_LIST=www01                     |
+                +                         +                                                                                               +                                       +
|                |                         | OPERATION_ID は自動で払い出されます。                                                         | SERVER_LIST=www01:www02               |
+                +                         +                                                                                               +                                       +
|                |                         | OPERATION_IDおよびMENU_IDとの併用はできません。                                               |                                       |
+                +-------------------------+-----------------------------------------------------------------------------------------------+---------------------------------------+
|                | HOST_NAME               | ITA のホストグループ管理のホスト紐付け管理に登録されているホスト名。                          | HOST_NAME=1:db01                      |
+                +                         +                                                                                               +                                       +
|                |                         | <メニューID>:<ホスト名>&<ホスト名>&...|<メニューID>:<ホスト名>...                             | HOST_NAME=1:db01&db02|2:www01         |
+                +                         +                                                                                               +                                       +
|                |                         | MENU_ID利用時のみ指定ができます。                                                             |                                       |
+                +-------------------------+-----------------------------------------------------------------------------------------------+---------------------------------------+
|                | HOSTGROUP_NAME          | ITA のホストグループ管理のホストグループ一覧で管理されているホストグループ名。                | HOSTGROUP_NAME=1:db-group|2:web-group |
+                +                         +                                                                                               +                                       +
|                |                         | MENU_ID利用時のみ指定ができます。                                                             |                                       |
+----------------+-------------------------+-----------------------------------------------------------------------------------------------+---------------------------------------+



.. note::
   | **CONVERT_FLGがTRUEの場合**
   | 条件部におけるルールの記述を以下のように加工した場合、使用することができます。
   | ・始めの条件を作業対象ホスト名でマッチングできるようにする。
   | ・2番目以降の条件をパラメータシートに連携する値でマッチングできるようにする。
   | ルールにマッチングされた値がそのままパラメータシートへ登録を行います。
   | パラメータシートへ値が登録される順番はイベント情報の順番になります。
   |
   | **CONVERT_FLGがFALSEの場合**
   | 条件部におけるルールの記述を加工せずに使用することができます。
   | ITAのパラメータシートへ連携される値はマッチングされた文言から指定された抽出条件によって抽出します。
   | 抽出する値には作業対象ホストが必要です。
   | パラメータシートへ値が登録される順番はメニューID毎に指定することができます。


ユースケース
------------

| **Case 1**
| ITAで設定済みの機器とパラメータを利用する

::

 ITA_NAME=exastro-ita01,CONDUCTOR_CLASS_ID=1,OPERATION_ID=1

::

 ITA_NAME=exastro-ita01,SYMPHONY_CLASS_ID=2,OPERATION_ID=2

| **Case 2**
| ITAで設定済みの機器とパラメータを利用し、OASEでホストを指定する

::

 ITA_NAME=exastro-ita01,CONDUCTOR_CLASS_ID=1,SERVER_LIST=www01

::

 ITA_NAME=exastro-ita01,SYMPHONY_CLASS_ID=2,SERVER_LIST=db01:db02

::

 ITA_NAME=exastro-ita01,CONDUCTOR_CLASS_ID=1,SERVER_LIST={{ VAR_<条件名> }}

| **Case 3**
| ITAで設定済みの対象ホストまたは対象ホストグループとパラメータシートを利用し、OASEで対象ホストまたは対象ホストグループを指定する。

::

 ITA_NAME=exastro-ita01,CONDUCTOR_CLASS_ID=1,MENU_ID=1,HOST_NAME=1:www01,CONVERT_FLG=FALSE

::

 ITA_NAME=exastro-ita01,CONDUCTOR_CLASS_ID=1,MENU_ID=1,HOSTGROUP_NAME=1:web-group,CONVERT_FLG=FALSE

::

 ITA_NAME=exastro-ita01,SYMPHONY_CLASS_ID=2,MENU_ID=2:3:4,HOST_NAME=2:www01,HOSTGROUP_NAME=3:db-group|4:app1-group&app2-group,CONVERT_FLG=FALSE
 
| **Case 4**
| 第1条件式にマッチした値をホスト名として、第2条件式以降にマッチした値をパラメータシートに連携する値として指定する。

::

 ITA_NAME=exastro-ita01,CONDUCTOR_CLASS_ID=1,CONVERT_FLG=TRUE

::

 ITA_NAME=exastro-ita01,SYMPHONY_CLASS_ID=2,CONVERT_FLG=TRUE

| **Case 5**
| 第1条件式にマッチした値をホスト名として、第2条件式以降にマッチした値の一部を抽出してパラメータシートに連携する値として指定する。

::

 ITA_NAME=exastro-ita01,CONDUCTOR_CLASS_ID=1,CONVERT_FLG=FALSE

::

 ITA_NAME=exastro-ita01,SYMPHONY_CLASS_ID=2,CONVERT_FLG=FALSE



Mail 連携
=========

| メール通知する際に利用するアクションパラメータについて記載します。

.. include:: ../include/mail_action.rst

ユースケース
------------

| **Case 1**
| 特定のユーザに対して通知メールを送信する。

::

 MAIL_NAME=management-mail,MAIL_TO=maintener@example.com,MAIL_CC=dev-team@example.com,MAIL_BCC=

| **Case 2**
| 特定のユーザに対してテンプレートを利用した通知メールを送信する。

::

 MAIL_NAME=management-mail,MAIL_TO=,MAIL_CC=dev-team@example.com,MAIL_BCC=,MAIL_TEMPLATE=service-down


ServiceNow 連携
===============

| ServiceNow と連携する際に利用するアクションパラメータについて記載します。

ServiceNowアクションパラメータ
------------------------------

+----------------+-------------------------+-------------------------------------------------------------------------------------------------------------+---------------------------------------+
| パラメータ分類 | パラメータ変数          | パラメータ値                                                                                                | 入力例                                |
+================+=========================+=============================================================================================================+=======================================+
| ドライバ名     | SERVICENOW_NAME         | ServiceNowドライバ名。                                                                                      | SERVICENOW_NAME=department01          |
+                +                         +                                                                                                             +                                       +
|                |                         | 必須項目です。                                                                                              |                                       |
+----------------+-------------------------+-------------------------------------------------------------------------------------------------------------+---------------------------------------+
| ワークフロー   | WORKFLOW_ID             | 実行したいワークフローが紐づく **ワークフロースケジュールの sys_id** を指定します。                         | WORLFLOW_ID=abcdef1234567890          |
+                +                         +                                                                                                             +                                       +
|                |                         | ワークフロー連携時のみ記載します。                                                                          |                                       |
+                +                         +                                                                                                             +                                       +
|                |                         | .. warning:: ワークフローの sys_id でないことに注意して下さい。                                             |                                       |
+----------------+-------------------------+-------------------------------------------------------------------------------------------------------------+---------------------------------------+
| インシデント   | INCIDENT_STATUS         | インシデントの起票、もしくは、更新するステータスを指定します。                                              | INCIDENT_STATUS=NEW                   |
|                |                         | インシデント管理時のみ記載します。                                                                          |                                       |
+                +                         +                                                                                                             +                                       +
|                |                         | :kbd:`NEW`: 新規インシデント起票時に指定します。                                                            | INCIDENT_STATUS=IN_PROGRESS           |
|                |                         | インシデント管理する場合は、必ず最初にマッチさせる必要があります。                                          |                                       |
+                +                         +                                                                                                             +                                       +
|                |                         | :kbd:`IN_PROGRESS`: ステータスを対処中にする場合に指定します。                                              | INCIDENT_STATUS=RESOLVED              |
|                |                         | 通常、ルールの記述の際にはアクション実行直前のルールで指定します。                                          |                                       |
+                +                         +                                                                                                             +                                       +
|                |                         | :kbd:`RESOLVED`: ステータスを解決済みにする場合に指定します。                                               | INCIDENT_STATUS=CLOSED                |
|                |                         | 通常、ルールの記述の際にはアクション実行直後のルールで指定します。                                          |                                       |
+                +                         +                                                                                                             +                                       +
|                |                         | :kbd:`CLOSED`: ステータスをクローズにする場合に指定します。                                                 |                                       |
|                |                         | 通常、ルールの記述の際にはクローズ承認後のルールで指定します。                                              |                                       |
+                +-------------------------+-------------------------------------------------------------------------------------------------------------+---------------------------------------+
|                | WORK_NOTES_APPROVAL     | アクション実行の許可文字列を指定します。                                                                    | WORK_NOTES_APPROVAL=APPROVED_ACTION   |
+                +                         +                                                                                                             +                                       +
|                |                         | ServiceNow の対応するインシデントの作業メモに許可文字列が記入された場合のみ処理を続行します。               | WORK_NOTES_APPROVAL=APPROVED_CLOSE    |
|                |                         | 許可文字列が記入されない場合、このアクションは処理中のまま何もしません。                                    |                                       |
+                +-------------------------+-------------------------------------------------------------------------------------------------------------+---------------------------------------+
|                | WORK_NOTES_REJECTED     | アクション実行の却下文字列を指定します。                                                                    | WORK_NOTES_REJECTED=REJECTED_ACTION   |
+                +                         +                                                                                                             +                                       +
|                |                         | ServiceNow の対応するインシデントの作業メモに却下文字列が記入された場合のみ処理を中止します。               | WORK_NOTES_REJECTED=REJECTED_CLOSE    |
|                |                         | 却下文字列が記入されない場合、このアクションは処理中のまま何もしません。                                    |                                       |
+----------------+-------------------------+-------------------------------------------------------------------------------------------------------------+---------------------------------------+


ユースケース
------------

| **Case 1**
| ワークフロースケジュールを利用して、ワークフローを実行する。

::

 SERVICENOW_NAME=department01,WORKFLOW_ID=abcdef1234567890


| **Case 2**
| インシデントの起票とステータスの更新をする。

::

 SERVICENOW_NAME=department01,INCIDENT_STATUS=NEW

::

 SERVICENOW_NAME=department01,INCIDENT_STATUS=CLOSED

| **Case 3**
| インシデントを利用して承認待ちをする。

::

 SERVICENOW_NAME=department01,INCIDENT_STATUS=IN_PROGRESS,WORK_NOTES_APPROVAL=APPROVED_ACTION,WORK_NOTES_REJECTED=REJECTED_ACTION


インシデント管理のベストプラクティス
------------------------------------

| Exastro OASE を使って、ServiceNow のインシデントと連携する場合は、下記のようにディシジョンテーブルファイルのルールを定義します。

.. csv-table:: インシデントと対処を管理するための疑似的なルール
   :name: rule_and_action
   :escape: \
   :header: ルール名, 条件, 発生事象, 対処概要, アクションパラメータ※ドライバ名省略
   :widths: 20, 35, 30, 40, 40

   インシデント起票, アラート名が ".* is down" である場合, サービスダウン発生, インシデントを起票します。[APPROVAL_REQUEST], INCIDENT_STATUS=NEW
   処理中, アラート名が "httpd is down" である場合, Apache サービスダウン発生, サービス再開処理開始をします。, INCIDENT_STATUS=IN_PROGRESS
   ITA実行, アラート名が "httpd is down" である場合, Apache サービスダウン発生, サービス再開処理を実施します。,CONDUCTOR_CLASS_ID=3\,OPERATION_ID=4
   処理完了, アラート名が "httpd is down" である場合, Apache サービスダウン発生, サービス再開処理が完了しました。,INCIDENT_STATUS=RESOLVED
   インシデントクローズ(承認あり), アラート名が "httpd is down" である場合, Apache サービスダウン発生, インシデントをクローズします。対処内容を確認の上、問題なければクローズ承認をお願いします。,INCIDENT_STATUS=CLOSED\,WORK_NOTES_APPROVAL=APPROVED_CLOSE\,WORK_NOTES_REJECTED=REJECTED_CLOSE

| ディシジョンテーブルファイルに記載した :program:`ルール名`、 :program:`発生事象`、 :program:`対処概要` は、ServiceNow のインシデントの説明欄に追記されます。

.. code-block:: text

    2022-01-11 10:45:35
    ルール名 : インシデントクローズ(承認あり)
    発生事象 : Apache サービスダウン発生
    対処概要 : インシデントをクローズします。対処内容を確認の上、問題なければクローズ承認をお願いします。
    ==================================================
    2022-01-11 10:45:32
    ルール名 : 処理完了
    発生事象 : Apache サービスダウン発生
    対処概要 : サービス再開処理が完了しました。
    ==================================================
    2022-01-11 10:43:34
    ルール名 : 処理中(承認あり)
    発生事象 : サービス再開処理を開始します。
    対処概要 : OASEにより通常ページに切り替えを行います。この対処に問題なければ承認をお願いします。
    ==================================================
    2022-01-11 10:43:32
    ルール名 : インシデント起票
    発生事象 : サービスダウン発生
    対処概要 : インシデントを起票します。[APPROVAL_REQUEST]

| 承認連携については、ServiceNow側での `Flow Designer <https://www.servicenow.co.jp/products/platform-flow-designer.html>`_ の設定が必要になります。
| 具体的には、 :numref:`approval_sequence` のように、インシデントテーブルの更新とインシデント内容説明文に記載されたトリガーとなる文字列(APPROVAL_REQUEST)を Flow 開始のトリガーとします。
| ユーザに承認依頼をし、承認された場合は作業メモに承認文字列を、却下された場合は作業メモに却下文字列を記入します。
| この作業メモの内容を Exastro OASE が読み取り、処理の継続か中止を決定します。

.. figure:: /images/ja/decision_table/approval_sequence.svg
   :name: approval_sequence
   :scale: 100%
   :align: center

   :numref:`rule_and_action` にマッチするメッセージを取得した場合の処理の流れ