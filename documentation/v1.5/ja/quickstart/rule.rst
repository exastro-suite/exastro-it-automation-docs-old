======================
ルール作成とルール適用
======================

| 監視アプリケーションからのアラート情報に対して実施する対処(アクション)の定義のことをルールと言います。
| 本項では、ルールの作成方法とその適用方法について説明します。


.. _new_rule:

ルール作成
==========

| ルールの作成には、ディシジョンテーブルファイルを利用します。
| ディシジョンテーブルファイルの取得は、画面上部のメニューの :menuselection:`ルール --> ディシジョンテーブル` から行います。
| :doc:`decision_table` で作成した :program:`新規ディシジョンテーブル` のダウンロードボタン :guilabel:`` 、ディシジョンテーブルファイルをダウンロードします。


.. figure:: /images/ja/quickstart/new_rule_01.png
   :width: 400px
   :align: center

   ディシジョンテーブルダウンロード

| ディシジョンテーブルファイルを開き、ルールを追加します。
| 記載内容の詳細についてはここでは省略します。詳細は、:doc:`../rule_definition/action` を参照して下さい。

| 特に重要な項目としては、下記となります。

アラートメッセージ(正規表現可 一致)
  | 監視アプリケーションから取得したアラートメッセージのマッチ条件を定義します。今回は、取得したアラート全てに対して、ITA を実行する条件となります。

アクションパラメータ情報（必須）
  | 自動化ソフトウェアのアクションドライバとそのパラメータを指定します。

  | :program:`ITA_NAME`
  |   :doc:`action_driver` で作成したアクションドライバのアクションドライバ名を指定します。
  | :program:`CONDUCTOR_CLASS_ID`
  |   Exastro OASE から実行する ITA の ConductorクラスIDを指定します。
  | :program:`OPERATION_ID`
  |   Exastro OASE から実行する ITA の Conductor に紐付けるオペレーション ID を指定します。



| また、本項で扱う全ての項目は下記となります。

+-------------------------------------+---------------------------------------------------------------------------+
| ルール説明                          | クイックスタート                                                          |
+-------------------------------------+---------------------------------------------------------------------------+
| アラートメッセージ(正規表現可 一致) | .*                                                                        |
+-------------------------------------+---------------------------------------------------------------------------+
| ルール名 （必須）                   | 新規ルール                                                                |
+-------------------------------------+---------------------------------------------------------------------------+
| 発生事象（必須）                    | アラートを検知                                                            |
+-------------------------------------+---------------------------------------------------------------------------+
| 対処概要（必須）                    | ITAを実行                                                                 |
+-------------------------------------+---------------------------------------------------------------------------+
| アクション種別                      | ITA(ver1)                                                                 |
+-------------------------------------+---------------------------------------------------------------------------+
| アクションパラメータ情報（必須）    | ITA_NAME=新規ZABBIXアクションドライバ,CONDUCTOR_CLASS_ID=1,OPERATION_ID=1 |
+-------------------------------------+---------------------------------------------------------------------------+
| 承認メールパラメータ情報（必須）    | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| リトライ間隔（必須）                | 1                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| リトライ回数（必須）                | 1                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 抑止間隔（必須）                    | 0                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 条件回数（必須）                    | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 条件期間(秒)（必須）                | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 大グループ（必須）                  | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 優先順位（必須）                    | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 小グループ（必須）                  | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 優先順位（必須）                    | X                                                                         |
+-------------------------------------+---------------------------------------------------------------------------+
| 有効日                              |                                                                           |
+-------------------------------------+---------------------------------------------------------------------------+
| 無効日                              |                                                                           |
+-------------------------------------+---------------------------------------------------------------------------+

.. figure:: /images/ja/quickstart/new_rule_02.png
   :width: 800px
   :align: center

   ディシジョンテーブルファイル(一部)

| ルールの記述が完了したら、ファイルを保存します。

新規トークンの払い出し
======================

| クイックスタートでは Exastro OASE で提供されている Web API を使ってアラート情報の投入を行います。本項では、Web API 利用で必要なトークンの払い出しを行います。
| 新規トークンの払い出しは、画面上部のメニューの :menuselection:`ルール --> トークン払い出し` から行います。
| トークンの詳細については、:doc:`../api/token` を参照してください。

| 画面上部にある、:guilabel:` 新規トークン払い出し` をクリックします。

.. figure:: /images/ja/quickstart/new_token_01.png
   :scale: 30%
   :align: left

   トークン払い出し

トークン名
   | トークン名を入力します。
   | クイックスタートでは :program:`新規トークン` として登録します。

有効期限
   | トークンの有効期限を指定します。
   | クイックスタートでは、未記入(有効期限なし)として登録します

権限の設定
   | グループに割り当てる権限を定義します。
   | クイックスタートでは :program:`権限あり` に設定します。

.. raw:: html

   <div style="clear:both;"></div>

| 項目の入力が完了したら、:guilabel:` トークン払い出し` をクリックします。
| トークンが画面上に表示されますが、後から確認できます。


ルールの検証
============

| ルールの設定は、画面上部のメニューの :menuselection:`ルール --> ルール` から行います。
| 画面上部にある :guilabel:` ファイルを選択` をクリックし、 :ref:`new_rule` で作成したディシジョンテーブルファイルを選択します。
| 選択したファイルが正しいことを確認し、:guilabel:` アップロード` をクリックします。

.. figure:: /images/ja/quickstart/rule_apply_01.png
   :width: 800px
   :align: center

| :menuselection:`作業ステータス` が :program:`ステージング適用完了` になっていることを確認し、ルールの検証のために :guilabel:` テストリクエスト` をクリックします。

.. tip:: 
   | ファイルアップロード時に何らかの問題が発生してエラーとなった場合は、 ダウンロードボタン :guilabel:`` をクリックし、ダウンロードした ZIP ファイルに梱包されているログファイルを確認して下さい。


.. figure:: /images/ja/quickstart/test_request_01.png
   :scale: 30%
   :align: left

   テストリクエスト(ディシジョンテーブル選択)

ディシジョンテーブル名選択
   | テストを行う対象のディシジョンテーブルを選択します。
   | クイックスタートでは :program:`新規ディシジョンテーブル` を選択します。

.. raw:: html

   <div style="clear:both;"></div>

| :guilabel:` テストリクエスト設定へ` をクリックします。

.. figure:: /images/ja/quickstart/test_request_02.png
   :scale: 30%
   :align: left

   テストリクエスト(テストリクエスト設定)

アラートメッセージ
   | テストリクエストで送信するメッセージを設定します。
   |  :menuselection:`単発テスト` でアラートメッセージを :kbd:`This is test alert.` と入力します。

.. raw:: html

   <div style="clear:both;"></div>

| :guilabel:` 実行` をクリックします。

.. figure:: /images/ja/quickstart/test_request_03.png
   :scale: 30%
   :align: left

   テストリクエスト(テストリクエスト設定)

| テストリクエストで送信したメッセージがディシジョンテーブルファイルで定義したルールにマッチしていることを確認します。

.. raw:: html

   <div style="clear:both;"></div>

| :guilabel:` 閉じる` をクリックします。
| 運用ステータスを :program:`検証完了` にするかどうかの確認があるので、:guilabel:`OK` をクリックします。


ルールの本番適用
================

| ルールの本番適用は、画面上部のメニューの :menuselection:`ルール --> ルール` から行います。
| 画面上部の :menuselection:`ステージング適用ルール` にある適用ボタン :guilabel:`` をクリックします。

| 数秒～数分後に、 :menuselection:`作業ステータス` が :program:`プロダクション適用完了` になります。

.. figure:: /images/ja/quickstart/rule_apply_02.png
   :width: 800px
   :align: center

| Exastro OASE が監視アプリケーションからアラートメッセージを取得すると、ITA の Conductor を実行します。