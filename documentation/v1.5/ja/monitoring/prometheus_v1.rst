==================
Prometheusアダプタ
==================

| Prometheus アダプタは、Prometheus で提供されているアラート情報(`Prometheus HTTP API - Alerts <https://prometheus.io/docs/prometheus/latest/querying/api/#alerts>`_)を能動的に取得するための仕組みです。
| ディシジョンテーブルに対して、複数の Prometheus サーバと連携することが可能です。

前提条件
========

* 監視アダプタの登録を行う際には、事前にディシジョンテーブルが登録されている必要があります。ディシジョンテーブルの登録方法に関しては、:doc:`../rule_definition/decision_table` を参照してください。
* Prometheus監視アダプタがインストール済みである必要があります。インストール方法については、:doc:`adapter_install` を参照してください。

新規登録
========

| 上メニューの :menuselection:`システム --> 監視アダプタ` から監視アダプタ画面を開きます。
| 画面上部にある、:guilabel:` 監視先の追加` ボタンを押下します。
| 「Prometheus Adapter ver1」を選択します。

.. tip::
    | 監視アダプタを追加するために、監視アダプタに対する「更新可能」のアクセス権限が必要です。


.. figure:: /images/ja/monitoring_adapter/monitoring_adapter_08_v1.5.png
   :scale: 80%
   :align: center

   監視アダプタの選択

| Prometheus アダプタの設定項目を入力します。

.. figure:: /images/ja/monitoring_adapter/monitoring_adapter_22.png
   :scale: 35%
   :align: left

   Prometheusアダプタ(ver. 1)設定画面


.. table:: Prometheusアダプタ(ver. 1)設定項目

   +----------------------------+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 設定項目                                                               | 説明                                                                                                                                                    |
   +============================+===========================================+=========================================================================================================================================================+
   | 名前                                                                   | 入力必須項目です。OASEで管理する監視アダプタの名前を設定してください。                                                                                  |
   +----------------------------+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   | URI                                                                    | Prometheus から取得したいデータの HTTP API の URI を指定します。アラートに関しては、http://your-prom-server/api/v1/alerts というAPIが提供されています。 |
   +----------------------------+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   | ディシジョンテーブル名選択                                             | 連携するディシジョンテーブルをプルダウンメニューから選択します。                                                                                        |
   +---------------+--------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 突合情報      | 監視情報 - イベント発生日時                            | HTTP API から取得結果の更新日時を指定します。                                                                                                           |
   |               +--------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   |               | 監視情報 - インスタンス情報                            | `Prometheus のアラート <https://prometheus.io/docs/prometheus/latest/querying/api/#alerts>`_ のインスタンスに該当するラベルを指定します。               |
   |               +--------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   |               | 条件名                                                 | `Prometheus のアラート <https://prometheus.io/docs/prometheus/latest/querying/api/#alerts>`_ で評価したい項目を選択します。                             |
   +---------------+--------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+

.. raw:: html

   <div style="clear:both;"></div>

| 例えば、下記のレスポンスを取得した場合の Promehteus 項目の指定方法は、以下のようになります。


.. code-block:: sh
   
   curl http://your-prom-server:9090/api/v1/alerts
   

.. code-block:: json

   {
       "data": {
           "alerts": [
               {
                   "activeAt": "2018-07-04T20:27:12.60602144+02:00",
                   "annotations": {},
                   "labels": {
                       "alertname": "my-alert",
                       "instance": "my-instance"
                   },
                   "state": "firing",
                   "value": "1e+00"
               }
           ]
       },
       "status": "success"
   }


.. csv-table:: API 取得結果と項目の指定
   :header: キーの指定方法,評価される値,説明
   :widths: 20, 30, 20

   data.alerts.[].activeAt,2018-07-04T20:27:12.60602144+02:00,更新日時
   data.alerts.[].annotations,(値なし),アノテーション
   data.alerts.[].labels.alertname,my-alert,アラート名
   data.alerts.[].labels.instance,my-instance,インスタンス名
   data.alerts.[].state,firing,ステータス
   data.alerts.[].value,1e+00,取得した値
   status,success,API取得結果



| 各項目の入力が完了したら、:guilabel:` 保存` ボタンを押し設定を保存します。


設定変更
========

| 上メニューの :menuselection:`システム --> 監視アダプタ` から監視アダプタ画面を開き、 :menuselection:`Prometheus Adapter ver1` タブを押下し、Prometheus アダプタの一覧を表示します。

.. figure:: /images/ja/monitoring_adapter/monitoring_adapter_20.png
   :scale: 60%
   :align: center

   Prometheus アダプタ一覧

| 編集対象の監視アダプタの詳細確認ボタン :guilabel:`` をクリックし、詳細画面を開きます。

.. figure:: /images/ja/monitoring_adapter/monitoring_adapter_21.png
   :scale: 60%
   :align: center

   Prometheus アダプタ詳細画面

| 画面下部にある :guilabel:` 編集` ボタンから編集画面を開き、該当の項目を編集します。

.. figure:: /images/ja/monitoring_adapter/monitoring_adapter_22.png
   :scale: 60%
   :align: center

   Prometheus アダプタ編集画面

| 各項目の入力が完了したら、:guilabel:` 保存` ボタンを押し設定を保存します。