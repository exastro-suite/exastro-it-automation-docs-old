===============
Grafanaアダプタ
===============

| Grafana アダプタは、Grafana で提供されているアラート情報(`Grafana HTTP API - Alerting API <https://grafana.com/docs/grafana/latest/http_api/alerting/#alerting-api>`_)を能動的に取得するための仕組みです。
| ディシジョンテーブルに対して、複数の Grafana サーバと連携することが可能です。

前提条件
========

* 監視アダプタの登録を行う際には、事前にディシジョンテーブルが登録されている必要があります。ディシジョンテーブルの登録方法に関しては、:doc:`../rule_definition/decision_table` を参照してください。
* Grafana監視アダプタがインストール済みである必要があります。インストール方法については、:doc:`adapter_install` を参照してください。

新規登録
========

| 上メニューの :menuselection:`システム --> 監視アダプタ` から監視アダプタ画面を開きます。
| 画面上部にある、:guilabel:` 監視先の追加` ボタンを押下します。
| 「Grafana Adapter ver1」を選択します。

.. tip::
    | 監視アダプタを追加するために、監視アダプタに対する「更新可能」のアクセス権限が必要です。


.. figure:: /images/ja/monitoring_adapter/monitoring_adapter_08_v1.5.png
   :scale: 80%
   :align: center

   監視アダプタの選択

| Grafana アダプタの設定項目を入力します。

.. figure:: /images/ja/monitoring_adapter/monitoring_adapter_27.png
   :scale: 35%
   :align: left

   Grafanaアダプタ(ver. 1)設定画面


.. table:: Grafanaアダプタ(ver. 1)設定項目

   +----------------------------+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 設定項目                                                               | 説明                                                                                                                                                    |
   +============================+===========================================+=========================================================================================================================================================+
   | 名前                                                                   | 入力必須項目です。OASEで管理する監視アダプタの名前を設定してください。                                                                                  |
   +----------------------------+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   | URI                                                                    | Grafana から取得したいデータの HTTP API の URI を指定します。アラートに関しては、http://your-grafana-server/api/alerts というAPIが提供されています。    |
   +----------------------------+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   | ユーザ名                                                               | Grafana HTTP API が利用可能なユーザ名を指定します。                                                                                                     |
   +----------------------------+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   | パスワード                                                             | Grafana HTTP API が利用可能なユーザ名に対するパスワードを指定します。                                                                                   |
   +----------------------------+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   | ディシジョンテーブル名選択                                             | 連携するディシジョンテーブルをプルダウンメニューから選択します。                                                                                        |
   +---------------+--------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   | 突合情報      | 監視情報 - イベント発生日時                            | HTTP API から取得結果の更新日時を指定します。                                                                                                           |
   |               +--------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   |               | 監視情報 - インスタンス情報                            | `Grafana のアラート <https://grafana.com/docs/grafana/latest/http_api/alerting/#alerting-api>`_ のインスタンスに該当するタグを指定します。              |
   |               +--------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+
   |               | 条件名                                                 | `Grafana のアラート <https://grafana.com/docs/grafana/latest/http_api/alerting/#alerting-api>`_ で評価したい項目を選択します。                          |
   +---------------+--------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+

.. raw:: html

   <div style="clear:both;"></div>

| 例えば、下記のレスポンスを取得した場合の Promehteus 項目の指定方法は、以下のようになります。

.. code-block:: sh

   curl http://your-grafana-server:3000/api/alerts/

.. code-block:: json

   [
     {
       "id": 1,
       "dashboardId": 1,
       "dashboardUId": "ABcdEFghij"
       "dashboardSlug": "sensors",
       "panelId": 1,
       "name": "fire place sensor",
       "state": "alerting",
       "newStateDate": "2018-05-14T05:55:20+02:00",
       "evalDate": "0001-01-01T00:00:00Z",
       "evalData": "evalMatches": [
         {
           "metric": "movement",
           "tags": {
             "name": "fireplace_chimney"
           },
           "value": 98.765
         }
       "executionError": "",
       "url": "http://grafana.com/dashboard/db/sensors"
     }
   ]


.. csv-table:: API 取得結果と項目の指定
   :header: キーの指定方法,評価される値
   :widths: 20, 30

   [].dashboardId,1
   [].dashboardUId,ABcdEFghij
   [].dashboardSlug,sensors
   [].panelId,1
   [].name,fire place sensor
   [].state,alerting
   [].newStateDate,2018-05-14T05:55:20+02:00
   [].evalDate,0001-01-01T00:00:00Z
   [].evalData.evalMatches.metric,movement
   [].evalData.evalMatches.tags.name,fireplace_chimney
   [].evalData.evalMatches.value,98.765
   [].executionError,
   [].url,http://grafana.com/dashboard/db/sensors


| 各項目の入力が完了したら、:guilabel:` 保存` ボタンを押し設定を保存します。


設定変更
========

| 上メニューの :menuselection:`システム --> 監視アダプタ` から監視アダプタ画面を開き、 :menuselection:`Grafana Adapter ver1` タブを押下し、Grafana アダプタの一覧を表示します。

.. figure:: /images/ja/monitoring_adapter/monitoring_adapter_28.png
   :scale: 60%
   :align: center

   Grafana アダプタ一覧

| 編集対象の監視アダプタの詳細確認ボタン :guilabel:`` をクリックし、詳細画面を開きます。

.. figure:: /images/ja/monitoring_adapter/monitoring_adapter_29.png
   :scale: 60%
   :align: center

   Grafana アダプタ詳細画面

| 画面下部にある :guilabel:` 編集` ボタンから編集画面を開き、該当の項目を編集します。

.. figure:: /images/ja/monitoring_adapter/monitoring_adapter_31.png
   :scale: 60%
   :align: center

   Grafana アダプタ編集画面

| 各項目の入力が完了したら、:guilabel:` 保存` ボタンを押し設定を保存します。