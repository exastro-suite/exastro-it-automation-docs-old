==========
ルール適用
==========

| 本章では、OASE のルール画面の機能および操作方法について説明します。
| ディシジョンテーブルへのルールの適用は下記の流れで行います。

* ステージング環境に対するルールの適用
* ルールの検証
* プロダクション環境に対するルールの適用
* ルールの切り戻し

ステージング環境とプロダクション環境
====================================

| Exastro OASE には、各ディシジョンテーブルに対して、ステージング環境とプロダクション環境を持ちます。
| 各環境についての説明は下記を参照して下さい。

ステージング環境
   | 作成したディシジョンテーブルファイル内のルールの妥当性検証に利用する環境です。
   | ここでの検証作業は、プロダクション環境を含む外部のシステムへ一切の影響を与えません。

プロダクション環境
   | ステージング環境で検証済みのルールを使用して、監視運用の自動化を行う環境です。

.. figure:: /images/ja/rule/staging_confirmation.png
   :scale: 45%
   :align: left
   
   ルール適用の流れ

.. figure:: /images/ja/rule/rule_00_01.png
   :scale: 40%
   :align: right

   ステージング環境とプロダクション環境の画面構成

.. raw:: html

   <div style="clear:both;"></div>


ステージング環境に対するルールの適用
====================================

| Exastro OASE では、ルールを適用するために、一度ステージング環境でルールを適用してからプロダクション環境に適用する必要があります。ステージング環境での確認プロセスを経由することで、ユーザの意図しない対処の実施を未然に防止し、安全にルールをプロダクション環境に適用することを目的としています。

ディシジョンテーブルファイルのアップロード
------------------------------------------

| ディシジョンテーブルをステージング環境にアップロードするためには、 :menuselection:`ルール --> ルール` 画面を開き、 :menuselection:`ステージング適用ルール` フレームにある :guilabel:` ファイルを選択` ボタンを押下し、ファイル選択ダイアログから作成済みのディシジョンテーブルファイルを選択します。

.. note::
   | ディシジョンテーブルの作成、および、ディシジョンテーブルファイルの取得方法については、 :doc:`rule_format` を参照してください。
   | また、ステージング環境へのルール適用には、対象となるディシジョンテーブルのステージング環境に対する「更新可能」のアクセス権限が必要です。

.. figure:: /images/ja/rule/rule_03_02.png
   :width: 75%
   :align: center

   ディシジョンテーブルファイルの選択

| ファイルを選択後に :guilabel:` アップロード` ボタンを押下することで、ディシジョンテーブルファイルのステージング環境への適用が開始されます。

.. note::
   | ステージング環境へのアクセス権限が「更新可能」の場合のみ、アップロードボタンは押下することができます。

.. figure:: /images/ja/rule/rule_03_03.png
   :width: 75%
   :align: center

   ディシジョンテーブルファイルのアップロード

ルール適用状況の確認
--------------------

| ディシジョンテーブルファイルのアップロードをすると、ルールの適用プロセスが開始されます。
| ディシジョンテーブルのルール適用状況は運用ステータスと作業ステータスから確認でき、運用ステータスが「検証未実施」となっていればステージング環境へのルール適用が完了です。

.. tip:: 
   | アップロードに失敗した場合は、ディシジョンテーブルファイルの記述に謝りがある可能性が高いです。
   | その場合は、:menuselection:`ステージング適用ルール` の該当するルールの :guilabel:`` ボタンからログファイルを取得することで原因を特定することができます。 

| ステージング適用ルールにおける、運用ステータスの詳細は下記の表のとおりです。

.. csv-table:: 運用ステータス(ステージング適用ルール)
   :header: ステータス名, 説明
   :widths: 20, 60

   未適用, アップロードを実施直後の状態。アップロード処理が正常に完了し、ステージング環境に適用されることで「検証未実施」状態へ遷移します。また、アップロード処理が異常終了した場合、この状態のままとなります。
   検証未実施, ステージング環境に適用されているルールに対して、テストリクエストによる検証を実行していない状態。テストリクエストを行う、もしくは、運用者の任意で「検証実施中」「検証NG」「検証完了」へ遷移可能です。
   検証実施中, ステージング環境に適用されているルールに対して、テストリクエストによる検証が完了していない状態。テストリクエストを行う、もしくは、運用者の任意で「検証NG」「検証完了」へ遷移可能です。また、運用者の任意で「検証未実施」へ戻すこともできます。
   検証NG, ステージング環境に適用されているルールに対して、テストリクエストによる検証が異常終了した状態。運用者の任意で「検証未実施」「検証実施中」「検証完了」へ遷移可能です。
   検証完了, ステージング環境に適用されているルールに対して、テストリクエストによる検証が正常終了した状態。この状態のとき、プロダクション環境への「適用」ボタンを押下することができます。また、プロダクション適用前であれば、運用者の任意で「検証未実施」「検証実施中」「検証NG」へ遷移可能です。
   検証完了(プロダクション適用済み), ルールがステージング環境に適用されている、かつ、プロダクション環境にも適用されている状態。この状態のとき、運用者の任意で状態遷移はできません。
   適用終了, 過去にステージング環境に適用されていたが、更新されルールが利用されなくなった状態。:guilabel:` 過去を含め表示` ボタンが「ON」の状態の場合のみ表示されます。

| ステージング適用ルールにおける、作業ステータスの詳細は下記の表のとおりです。

.. csv-table:: 作業ステータス(ステージング適用ルール)
   :header: ステータス名, 説明
   :widths: 20, 60

   アップロード中, アップロードを実施直後のディシジョンテーブルの状態。
   アップロード異常終了, アップロード処理中に異常が発生し、処理が中断された状態。
   アップロード完了, アップロード処理が正常終了した状態。その後、自動的にビルド処理が実行され、「ビルド中」状態へ遷移します。
   ビルド中, アップロードされたディシジョンテーブルファイルを元に、ディシジョンテーブルのプロジェクトがビルドされている状態。
   ビルド異常終了, ビルド処理中に異常が発生し、処理が中断された状態。
   ビルド完了, ビルド処理が正常終了した状態。自動的にステージング適用処理が実行されると「ステージング適用中」状態へ遷移します。
   ステージング適用中, ビルドされたプロジェクトをデプロイ中の状態。
   ステージング適用異常終了, デプロイ処理中に異常が発生し、処理が中断された状態。
   ステージング適用完了, デプロイ処理が正常終了した状態。

.. note::
   | 自動更新制御ボタンがONであり、アップロード中、ビルド中、ステージング適用中のいずれかのステータスが一覧の中に一つでもある場合、5秒間隔で自動的に一覧の更新が行われます。

ルールの検証
============

| アップロードされたルールの検証を行う手段として、テストリクエストの機能が提供されています。
| これは、アップロードしたルールがユーザの想定通り条件に一致するかを確認するための機能です。
| 上記の理由からルールの検証を行うことを推奨しますが、ルールの検証が不要な場合は、:ref:`change_operatioin_status` を行うことで本手順をスキップすることが可能です。

| テスト実施の方法には、単発のリクエスト送信による単発テストと複数のリクエストを同時に送信する一括テストの2通りの方法があります。

.. note::
   | テストの実施には、対象となるディシジョンテーブルのステージング環境に対する「参照のみ」、「更新可能」のアクセス権限が必要です。
   
テスト実施(単発テスト)
----------------------

| 単発テストは、画面からの操作のみでテストを実行できるため簡単にテストを実施できるメリットがあります。

| :guilabel:` テストリクエスト` ボタンを押下し、テストリクエスト画面へ遷移します。
| テスト実施対象のディシジョンテーブルをプルダウンから選択します。

.. figure:: /images/ja/rule/rule_03_04.png
   :scale: 30%
   :align: left

   テストリクエスト

.. figure:: /images/ja/rule/rule_03_13_02.png
   :scale: 45%
   :align: right

   ディシジョンテーブル選択

.. raw:: html

   <div style="clear:both;"></div>

| ディシジョンテーブルの選択し、 :guilabel:` テストリクエスト設定へ` ボタンを押下します。
| :menuselection:`単発テスト` を押下し、テストリクエストで投入する内容を記入します。

.. figure:: /images/ja/rule/rule_03_18.png
   :scale: 45%
   :align: left

   テストリクエスト設定

.. csv-table:: テストリクエスト設定項目
   :header: 項目名, 説明
   :widths: 30, 100

   イベント発生日時, 現在時刻が自動的に入力されます。
   リクエスト項目, ディシジョンテーブルで定義されている条件部に対して、テストリクエストで送信する値を設定します。Web API により投入されるリクエストや監視アダプタから取得したイベント情報により想定される値を記入します。

.. raw:: html

   <div style="clear:both;"></div>

| 各項目にテスト用の値を入力したら、下部の :guilabel:` 実行` ボタンを押下し、テストを実施します。

テスト実施(一括テスト)
----------------------

| 一括テストは、スプレッドシートに事前にテストで検証したい値のパターンを複数用意することで、一度に複数の検証を実施できるメリットがあります。

| :guilabel:` テストリクエスト` ボタンを押下し、テストリクエスト画面へ遷移します。
| テスト実施対象のディシジョンテーブルをプルダウンから選択します。

.. figure:: /images/ja/rule/rule_03_04.png
   :scale: 30%
   :align: left

   単発テストリクエスト

.. figure:: /images/ja/rule/rule_03_13_02.png
   :scale: 45%
   :align: right

   ディシジョンテーブル選択

.. raw:: html

   <div style="clear:both;"></div>

| ディシジョンテーブルの選択し、 :guilabel:` テストリクエスト設定へ` ボタンを押下します。
| :menuselection:`一括テスト` を押下し、:guilabel:` 一括テスト用Excelファイルのダウンロード` ボタンからファイルをダウンロードします。
| ダウンロードした一括テスト用Excelファイルに、ディシジョンテーブルで定義されている条件部に対して、テストリクエスト送信の値を記入します。Web API により投入されるリクエストや監視アダプタから取得したイベント情報により想定される値を記入します。

.. figure:: /images/ja/rule/rule_03_19.png
   :scale: 40%
   :align: left

   一括テストリクエスト設定

.. figure:: /images/ja/rule/rule_04_01.png
   :scale: 25%
   :align: right

   一括テスト用Excelファイル

.. raw:: html

   <div style="clear:both;"></div>

| 各項目にテストリクエスト送信の値を入力したら、:guilabel:` ファイルを選択する` ボタンから記入済みの一括テスト用Excelファイルをアップロードし、下部の :guilabel:` 実行` ボタンを押下し、テストを実施します。

テスト実行結果の確認
--------------------

| テストが開始されると、:menuselection:`実行ログ` 画面に遷移し、その実行状況が出力されます。
| 実行状況は定期的に取得され、随時ログの出力内容が更新されます。
| 実行状況の取得は、テストが完了する、もしくは、テストリクエスト画面が閉じられるまで行われます。

.. figure:: /images/ja/rule/rule_03_25_01.png
   :scale: 40%
   :align: left

   実行ログ(単発テスト)

.. csv-table:: ログ出力内容(単発テスト)
   :header: No., 出力項目, 説明
   :widths: 5, 25, 60

   1, ステージング実行開始, テストリクエストが実行された日時が表示されます。
   2, リクエスト情報, 設定タブのリクエスト項目にて入力された情報が表示されます。
   3, 実行状態, テストの実行状態が表示されます。
   4, マッチング結果, テストが完了した際、ディシジョンテーブルから受信したルールのマッチング結果が表示されます。テストが完了していない、もしくは、ルールがマッチングしなかった場合は何も表示されません。

.. raw:: html

   <div style="clear:both;"></div>

.. figure:: /images/ja/rule/rule_03_25_02.png
   :scale: 40%
   :align: left

   実行ログ(一括テスト)

.. csv-table:: ログ出力内容(一括テスト)
   :header: No., 出力項目, 説明
   :widths: 5, 25, 60

   1, ステージング実行開始, テストリクエストが実行された日時が表示されます。
   2, ファイル名, リクエストが記述された一括リクエストファイル名が表示されます。
   3, 処理件数, 分母に送信されたリクエスト数、分子にテストが完了したリクエスト数が表示されます。
   4, 実行状態, 各リクエストごとに、ファイル内の記述行、および、テストの実行状態が表示されます。ディシジョンテーブルからマッチング結果を受信した場合、その件数、および、アクションパラメーターが表示されます。

.. raw:: html

   <div style="clear:both;"></div>

| 実行ログは、テストの証跡取得のためにテキストファイルとして出力するが可能です。

.. figure:: /images/ja/rule/rule_03_27.png
   :scale: 40%
   :align: center

   ログダウンロード

| テスト実行が完了したら、:guilabel:` 閉じる` を押下するとルール画面に戻ります。
| このとき、「運用ステータスを検証完了にしてよろしいですか？」と確認メッセージが表示されます。
| :guilabel:`OK` を選択すると運用ステータスが「検証完了」へ、「キャンセル」を選択すると運用ステータスが「検証実施中」へ遷移します。

.. figure:: /images/ja/rule/rule_03_31.png
   :scale: 40%
   :align: center

   検証の終了

.. _change_operatioin_status:

手動による運用ステータスの変更
------------------------------

| ルールファイルの運用ステータスが「検証未実施」「検証実施中」「検証NG」「検証完了」のいずれかに該当、かつ、プロダクション環境へ適用していない場合、運用者の任意でステータスを変更できます。
| ステージング環境へのアクセス権限が「更新可能」の場合のみ、運用ステータスの変更は押下することができます。

.. figure:: /images/ja/rule/rule_03_06.png
   :scale: 80%
   :align: center

   運用ステータスの変更

プロダクション環境に対するルールの適用
======================================

| ステージング適用ルールにおける運用ステータスが「検証完了」の場合、ルールをプロダクション環境へ適用させることができます。
| 適用させたい :menuselection:`ステージング適用ルール` の :guilabel:`` ボタンを押下することで、プロダクション環境にルールを適用します。

.. warning:: 
   | :guilabel:`` ボタンを押下すると、プロダクション環境に新しいルールでの対処が開始されます。

.. note::
   | プロダクション環境へのルール適用には、対象となるディシジョンテーブルのプロダクション環境に対する「更新可能」のアクセス権限が必要です

.. figure:: /images/ja/rule/rule_03_08.png
   :scale: 80%
   :align: center

   プロダクション環境への適用

| プロダクション環境へルールの適用を実施すると、作業ステータスや運用ステータスが更新されます。
| プロダクション適用ルールの運用ステータスが「プロダクション適用」となれば正常です。

.. figure:: /images/ja/rule/rule_03_09.png
   :scale: 80%
   :align: center

   プロダクション適用ルール

| プロダクション適用ルールにおける運用ステータスは下記のとおりです。

.. csv-table:: 運用ステータス(プロダクション適用ルール)
   :header: ステータス名, 説明
   :widths: 20, 60

   プロダクション未適用, ステージング環境に適用されているルールをプロダクション環境へ適用実施直後の状態。適用処理が異常終了した場合、この状態のままとなります。
   プロダクション適用, 現在適用中のプロダクションの状態。
   プロダクション適用終了, 過去にプロダクション環境に適用されていたが、更新されルールが利用されなくなった状態。:guilabel:` 過去を含め表示` ボタンが「ON」の状態の場合のみ表示されます。

| プロダクション適用ルールにおける作業ステータスは下記のとおりです。

.. csv-table:: 作業ステータス説明(プロダクション適用ルール)
   :header: ステータス名, 説明
   :widths: 20, 60

   プロダクション適用中, ステージング環境に適用されているルールをプロダクション環境へ適用実施直後、もしくは、切り戻しによる再適用の実行直後の状態。
   プロダクション適用異常終了, プロダクション適用中に異常が発生した状態。
   プロダクション適用完了, プロダクション適用処理が正常終了した状態。

ルールの切り戻し
================

| ルールの記述に誤りがあった場合、Exastro OASE ではルールの適用履歴から過去のルールに戻すことが可能です。

| :menuselection:`プロダクション適用ルール` のパネル右上にある :guilabel:` 過去を含め表示` を「ON」に切り替え、過去の適用履歴を表示させます。
| :guilabel:` 過去を含め表示` 機能は通常は「OFF」となっており、押下することでON/OFFが切り替わります。

| 過去にプロダクション環境へ適用されていたルールを確認するために、ダウンロードボタン :guilabel:`` から当時のディシジョンテーブルファイルを取得します。
| ダウンロードしたディシジョンテーブルファイルの内容を確認し問題なければ、切り戻しボタン :guilabel:`` を押下し、再度プロダクション環境へルール適用(切り戻し)を実施します。

.. note::
   | プロダクション環境へのルール適用には、対象となるディシジョンテーブルのプロダクション環境に対する「更新可能」のアクセス権限が必要です

.. figure:: /images/ja/rule/rule_03_12.png
   :scale: 80%
   :align: center

   プロダクション適用ルールの履歴からルールの再適用

ルールの評価結果
================

| ルールの評価結果については、:doc:`../rule_maintenance/action_history` を参照してください。