==========================
ディシジョンテーブルの管理
==========================

| ディシジョンテーブルは、監視アプリケーションから取得・受信したアラートメッセージを解析し、ルールの条件に一致するかどうかの判断を行います。

| ディシジョンテーブル画面の機能、操作方法について説明します。
| ディシジョンテーブル画面では、OASE を利用して作業を行う上で共通に必要となる以下の機能を提供します。

* ディシジョンテーブルの新規追加、編集、複製、削除
* ディシジョンテーブルの権限設定


ディシジョンテーブルの新規追加・編集
====================================

| ディシジョンテーブルの設定は、画面上部のメニューの :menuselection:`ルール --> ディシジョンテーブル` から行います。
| 新たにディシジョンテーブルを作成する場合、:guilabel:`新規追加` をクリックします。
| 既存のディシジョンテーブルを編集する場合、編集対象のディシジョンテーブルの詳細画面ボタン :guilabel:`` をクリックします。


基本情報・権限設定
------------------

| :menuselection:`基本情報・権限` 設定フォームから設定を行います。

.. figure:: /images/ja/quickstart/new_decision_table_01.png
   :width: 400px
   :align: left

   基本情報・権限設定

ディシジョンテーブル名
   | ディシジョンテーブル名を入力して下さい。マルチバイト含む文字列の入力が可能です。
   |  :program:`新規ディシジョンテーブル` として登録します。

権限の設定
   | グループに割り当てる権限を定義します。
   | 各項目の詳細については、:numref:`decision_table_authentication` を参照して下さい。
  
.. raw:: html

   <div style="clear:both;"></div>


.. table:: 権限の設定
   :name: decision_table_authentication

   +----------+----------------------+--------------------+----------------------------------------------------------------------------------------+
   | カテゴリ | 画面                 | 機能               | 説明                                                                                   |
   +==========+======================+====================+========================================================================================+
   | ルール   | ディシジョンテーブル | 編集・削除         | このディシジョンテーブルに対する編集と削除の権限を設定します。                         |
   +          +----------------------+--------------------+----------------------------------------------------------------------------------------+
   |          | ルール               | ステージング環境   | このディシジョンテーブルに紐づくステージング環境の権限を設定します。                   |
   +          +                      +--------------------+----------------------------------------------------------------------------------------+
   |          |                      | プロダクション環境 | このディシジョンテーブルに紐づくプロダクション環境の権限を設定します。                 |
   +          +----------------------+--------------------+----------------------------------------------------------------------------------------+
   |          | リクエスト履歴                            | このディシジョンテーブルに紐づくアダプターが取得したリクエスト履歴の権限を設定します。 |
   +          +----------------------+--------------------+----------------------------------------------------------------------------------------+
   |          | アクション履歴                            | このディシジョンテーブルで実施したアクション履歴の権限を設定します。                   |
   +----------+----------------------+--------------------+----------------------------------------------------------------------------------------+
   | システム | 監視アダプタ                              | 監視アダプタ設定におけるこのディシジョンテーブルへの権限を設定します。                 |
   +----------+----------------------+--------------------+----------------------------------------------------------------------------------------+

| 入力が完了したら、:guilabel:`条件式の設定へ` をクリックします。


条件式設定
----------

| :menuselection:`条件式` 設定フォームで、アラートメッセージに対する条件式を設定を行います。

.. warning::
   | 一度設定した条件式の追加、編集、削除はできません。
   | これらの操作が必要な場合は、下記に記載の移行手順を参考に実施して下さい。

.. figure:: /images/ja/quickstart/new_decision_table_02.png
   :width: 400px
   :align: left

   条件式

条件名
   | 条件に対する名前を入力して下さい。

条件式
   | 条件式は、監視アプリケーションから取得したイベント(メッセージ)を評価するための式です。
   | ディシジョンテーブルに記載の値との関係を表します。
   | アラートメッセージがこの条件式に一致する場合、Exastro OASE はアクションを実行します。
   | 各条件式については、:numref:`decision_table_conditions` を参照して下さい。

.. raw:: html

   <div style="clear:both;"></div>

.. include:: ../include/decision_table_conditions.rst

| 入力が完了したら、:guilabel:`未知事象通知の設定へ` をクリックします。


未知事象通知設定
----------------

| :menuselection:`未知事象通知` 設定フォームで、通知先の設定を行います。

.. figure:: /images/ja/quickstart/new_decision_table_03.png
   :width: 400px
   :align: left

   未知事象通知

未知事象通知
   | 未知事象(ルールに定義されていないイベント)が発生した場合の通知先を設定します。
   |  未知事象通知については、:numref:`unknown_event_notification` を参照して下さい。


.. raw:: html

   <div style="clear:both;"></div>

.. csv-table:: 未知事象通知
   :name: unknown_event_notification
   :header: 設定項目, 説明
   :widths: 30, 70

   通知しない, 未知事象を検知した場合に、何もしません。
   メールで通知する, 未知事象を検知した場合に、「通知先メールアドレス」にメールを送信します。
   ServiceNowと連携する, 未知事象を検知した場合に、「ServiceNowDriver名」で指定した ServiceNow ドライバに紐づくアカウントに対し、新規インシデントとして起票をします。
   メールで通知する＆ServiceNowと連携する, 未知事象を検知した場合に、メールでの通知と ServiceNow に新規インシデントの起票をします。

| 全ての項目の入力が完了したら、:guilabel:` 保存` をクリックします。

| 新規に追加したディシジョンテーブルが一覧画面に表示されます。

.. figure:: /images/ja/quickstart/new_decision_table_04.png
   :width: 800px
   :align: center

   ディシジョンテーブル一覧


.. _copy_decision_table:

ディシジョンテーブルの複製と編集
================================

| 既存のディシジョンテーブルを基にディシジョンテーブルを新規追加することができます。
| 権限、条件式および未知事象通知の情報を引き継いだディシジョンテーブル複製画面が表示されます。

| ディシジョンテーブルを複製する場合、複製対象のディシジョンテーブルの詳細画面ボタン :guilabel:`` をクリックします。
| 設定フォームの下部にある複製ボタン :guilabel:`` を押下します。
| ディシジョンテーブル名を入力し、各種設定値を入力後 :guilabel:` 保存` を押下し、登録をします。

.. note::
   | 既存のディシジョンテーブルと同じ名前をつけることは出来ません。


.. _delete_decision_table:

ディシジョンテーブルの削除
==========================

| ディシジョンテーブルの削除には、ユーザが所属するグループが削除対象のディシジョンテーブルに対して編集・削除の「更新可能」権を持っている必要があります。

| ディシジョンテーブルを削除する場合、削除対象のディシジョンテーブルの詳細画面ボタン :guilabel:`` をクリックします。
| 設定フォームの下部にある削除ボタン :guilabel:`` を押下します。

.. danger::
   | ディシジョンテーブルを削除した場合、ディシジョンテーブルと登録されているディシジョンテーブルファイルが削除され、復旧することはできません。
   | リクエスト履歴やアクション履歴は削除されません。


ディシジョンテーブルの移行
==========================

| 一度作成したディシジョンテーブルの条件式を編集することはできません。
| この場合、既存のディシジョンテーブルからの移行が必要となります。
| 下記の手順により、安全にディシジョンテーブルを移行できます。

1. :ref:`copy_decision_table`
2. 既存ルールの移行
3. ディシジョンテーブルに紐づく監視アダプタの切り替え
4. :ref:`delete_decision_table`

.. figure:: /images/ja/decision_table/migrate_decision_table.svg
   :width: 800px
   :align: center

   ディシジョンテーブルの移行イメージ

既存ディシジョンテーブルの複製・編集
------------------------------------

#. :ref:`copy_decision_table` の手順に従い、既存の設定を流用した形でディシジョンテーブルを複製します。
#. ディシジョンテーブル名を入力し、条件式を編集します。

既存ルールの移行
----------------

#. 新ディシジョンテーブルファイルに既存のルールを転記・修正します。
#. 新ディシジョンテーブルファイルをステージング適用し、ルールのテストを実施します。
#. ルールの検証が完了したら新ディシジョンテーブルに対するルールをプロダクション環境へ適用します。

ディシジョンテーブルに紐づく監視アダプタの切り替え
--------------------------------------------------

#. ディシジョンテーブルに紐づく監視アダプタの設定フォームから、新しいディシジョンテーブルに紐付けを変更します。

旧ディシジョンテーブルの削除
----------------------------

#. 移行が正常に完了したら :ref:`delete_decision_table` の手順に従い、ディシジョンテーブルを削除します。
